From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Sun, 3 Jul 2022 20:48:38 +0200
Subject: [PATCH] Add option for strict advancement dimension checks

Craftbukkit attempts to translate worlds that use the
same generation as the Overworld, The Nether, or The End
to use those dimensions when checking the `changed_dimension`
criteria trigger, or whether to trigger the `NETHER_TRAVEL`
distance trigger. This adds a config option to ignore that
and use the exact dimension key of the worlds involved.

diff --git a/src/main/java/com/destroystokyo/paper/PaperConfig.java b/src/main/java/com/destroystokyo/paper/PaperConfig.java
index 8379c6313f06ab3eeaf02bad41d8b835d50e093f..a5b36ea85e2efcb994bab32dc2bf9b66879a8d48 100644
--- a/src/main/java/com/destroystokyo/paper/PaperConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperConfig.java
@@ -689,6 +689,11 @@ public class PaperConfig {
         useDimensionTypeForCustomSpawners = getBoolean("settings.use-dimension-type-for-custom-spawners", false);
     }
 
+    public static boolean strictAdvancementDimensionCheck;
+    private static void strictAdvancementDimensionCheck() {
+        strictAdvancementDimensionCheck = getBoolean("settings.strict-advancement-dimension-check", false);
+    }
+
     public static boolean useProxyProtocol;
     private static void useProxyProtocol() {
         useProxyProtocol = getBoolean("settings.proxy-protocol", false);
diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index a6edf5117d4ae03d8294e7bb74dd2d77048895a5..9ec6ab487af881acd5a56f80ff41c52ada03ede8 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -1243,6 +1243,12 @@ public class ServerPlayer extends Player {
         // CraftBukkit start
         ResourceKey<Level> maindimensionkey = CraftDimensionUtil.getMainDimensionKey(origin);
         ResourceKey<Level> maindimensionkey1 = CraftDimensionUtil.getMainDimensionKey(this.level);
+        // Paper start - config for strict advancement checks for dimensions
+        if (com.destroystokyo.paper.PaperConfig.strictAdvancementDimensionCheck) {
+            maindimensionkey = resourcekey;
+            maindimensionkey1 = resourcekey1;
+        }
+        // Paper end
 
         CriteriaTriggers.CHANGED_DIMENSION.trigger(this, maindimensionkey, maindimensionkey1);
         if (maindimensionkey != resourcekey || maindimensionkey1 != resourcekey1) {
